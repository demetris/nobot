##  ----    ----    ----    ----    ----    ----    ----    ----    ----    ----    ----    ----  ##
##  DETECTION TYPE:                                                                               ##
##  CLIENT ERROR RESPONSE: 451                                                                    ##
##                                                                                                ##
##  DESCRIPTION                                                                                   ##
##                                                                                                ##
##  Response for bots that impersonate other bots                                                 ##
##                                                                                                ##
##                                                                                                ##
##  ----    ----    ----    ----    ----    ----    ----    ----    ----    ----    ----    ----  ##


##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -
##
##  IF
##    Request is whitelisted by the user
##    OR User-Agent is of a web browser
##  THEN
##    Skip rules for bot impersonators
##
##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -

RewriteCond %{ENV:NOBOT_ALLOWED_BY_USER}                "=1"                    [OR]
RewriteCond %{ENV:UA_IS_WEB_BROWSER}                    "=1"

RewriteRule .* - [S=8]


  ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -
  ##
  ##
  ##
  ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -

  ##  User-Agent is old; Bing stopped using it in 2022.
  RewriteCond %{HTTP_USER_AGENT}  "=Mozilla/5.0 (compatible; bingbot/2.0; +http://www.bing.com/bingbot.htm)"      [OR]

  ##  Misses lots of parts, including a plus sign.
  RewriteCond %{HTTP_USER_AGENT}  "=Mozilla/5.0 (iPhone; U; CPU iPhone OS) (compatible; Googlebot-Mobile/2.1;  http://www.google.com/bot.html)"

  RewriteRule .* - [R=451,L,E=NOBOT:80000]


  ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -
  ##
  ##  Impersonates Baiduspider
  ##
  ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -

  RewriteCond %{HTTP_USER_AGENT}  "=Baiduspider ( http://www.baidu.com/search/spider.htm)"
  
  RewriteRule .* - [R=451,L,E=NOBOT:80000]


  ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -
  ##
  ##  Impersonates BingPreview
  ##
  ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -

  ##
  ##  2026-02-07. It seems this User-Agent is no longer used by Bing.
  ##  The following search returns zero results:
  ##  https://www.google.com/search?q=BingPreview/1.0b+site:bing.com
  ##
  ##  2026-02-07. It seems this User-Agent is still used by Bing: Saw requests from *.search.msn.com
  ##    Rule should be removed. Commenting out for now.
  ##
  ####RewriteCond %{HTTP_USER_AGENT}  "=Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/534+ (KHTML, like Gecko) BingPreview/1.0b"
  ####RewriteRule .* - [R=451,L,E=NOBOT:80000]


  ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -
  ##
  ##  Impersonates Googlebot
  ##
  ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -

  RewriteCond %{HTTP_USER_AGENT}  "=Mozilla/5.0 (compatible; Googlebot/2.1)"                                                                                [OR]
  RewriteCond %{HTTP_USER_AGENT}  "^Mozilla/5\.0 \(compatible; Googlebot/2\.1; \+https?://www\.google\.com/bot\.html\)$"                                    [OR]
  RewriteCond %{HTTP_USER_AGENT}  "^Mozilla/5\.0 AppleWebKit/537\.36 \(KHTML, like Gecko; compatible; Googlebot/2\.1; \+http://www\.google\.com/bot\.html\) Chrome/[^ ]+ Safari/[^ ]+$"

  RewriteCond %{REMOTE_ADDR}      "!^34\."
  RewriteCond %{REMOTE_ADDR}      "!^35\."
  RewriteCond %{REMOTE_ADDR}      "!^66\."
  RewriteCond %{REMOTE_ADDR}      "!^192\."
  RewriteCond %{REMOTE_ADDR}      "!^2001:4860:"

  RewriteRule .* - [R=451,L,E=NOBOT:80000]


  ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -
  ##
  ##  Impersonates the Letâ€™s Encrypt validation server
  ##
  ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -

  RewriteCond  %{REQUEST_URI}      "!^/\.well-known/acme-challenge/"

  RewriteCond  %{HTTP_USER_AGENT}  "=Mozilla/5.0 (compatible; Let's Encrypt validation server; +https://www.letsencrypt.org)"

  RewriteRule .* - [R=451,L,E=NOBOT:80000]


  ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -
  ##
  ##  Impersonates Mediapartners-Google
  ##
  ##  Mediapartners-Google: https://developers.google.com/search/docs/crawling-indexing/google-special-case-crawlers
  ##  Mediapartners-Google addresses: https://developers.google.com/static/search/apis/ipranges/special-crawlers.json
  ##
  ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -

  RewriteCond %{HTTP_USER_AGENT}  "Mediapartners-Google"

  RewriteCond %{REMOTE_ADDR}      "!^66\."
  RewriteCond %{REMOTE_ADDR}      "!^72\."
  RewriteCond %{REMOTE_ADDR}      "!^74\."
  RewriteCond %{REMOTE_ADDR}      "!^108\."
  RewriteCond %{REMOTE_ADDR}      "!^192\."
  RewriteCond %{REMOTE_ADDR}      "!^209\."
  RewriteCond %{REMOTE_ADDR}      "!^2001:"

  RewriteRule .* - [R=451,L,E=NOBOT:80000]


  ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -
  ##
  ##  Impersonates Pinterestbot
  ##
  ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -

  RewriteCond %{REMOTE_ADDR}      "!^54\.236\.1\."

  RewriteCond %{HTTP_USER_AGENT}  "=Mozilla/5.0 (compatible; Pinterestbot/1.0; +http://www.pinterest.com/bot.html)"

  RewriteRule .* - [R=451,L,E=NOBOT:80000]


  ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -
  ##
  ##  Tries to Impersonate Mediapartners-Google.
  ##
  ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -

  RewriteCond %{HTTP_USER_AGENT}  "=Mozilla/5.0 (Macintosh; Intel Mac OS X 10_7_3) AppleWebKit/537.36 (KHTML, like Gecko, Mediapartners-Google) Chrome/89.0.4389.93 Safari/537.36"

  RewriteRule .* - [R=451,L,E=NOBOT:80000]


  ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -
  ##
  ##  Seems like a ClaudeBot impersonator
  ##
  ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -

  RewriteCond %{HTTP_USER_AGENT}  "=Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36; ClaudeBot/1.0; +claudebot@anthropic.com)"

  RewriteRule .* - [R=451,L,E=NOBOT:80000]


##
##
##
##  END OF SKIP
##
##
##

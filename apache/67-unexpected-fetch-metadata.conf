##  ----    ----    ----    ----    ----    ----    ----    ----    ----    ----    ----    ----  ##
##  DETECTION TYPE: Deterministic                                                                 ##
##  CLIENT ERROR RESPONSE: 451                                                                    ##
##                                                                                                ##
##  DESCRIPTION                                                                                   ##
##                                                                                                ##
##  Response for requests with unexpected Sec-Fetch-* fields                                      ##
##  or unexpected Sec-Fetch-* fields combined with other unexpected field values                  ##
##                                                                                                ##
##                                                                                                ##
##  - - - - - - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - - - - -  ##


##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -
##
##  IF
##    Request is whitelisted by the user
##    OR User-Agent is of search-engine bot
##  THEN
##    Skip all rules for fetch metadata
##
##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -

RewriteCond %{ENV:NOBOT_ALLOWED_BY_USER}            "=1"                        [OR]
RewriteCond %{ENV:UA_IS_SEARCH_ENGINE_BOT}          "=1"

RewriteRule .* - [S=9]


  ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -
  ##
  ##  IF
  ##    Sec-Fetch-Dest is empty
  ##  THEN
  ##    Skip rules for Sec-Fetch-Dest value
  ##
  ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -

  RewriteCond %{HTTP:Sec-Fetch-Dest}  "^$"

  RewriteRule .* - [S=3]


    ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -
    ##  RULE CONFIDENCE: 10
    ##
    ##  Sec-Fetch-Dest is unexpectedly present.
    ##
    ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -

    RewriteCond %{HTTP:Sec-Fetch-Dest}  "!^$"

    RewriteCond %{ENV:UA_IS_CHROME_0_TO_69}             "=1"                        [OR]
    RewriteCond %{ENV:UA_IS_FIREFOX_0_TO_89}            "=1"                        [OR]
    RewriteCond %{ENV:UA_IS_SAFARI_3_TO_16_3}           "=1"                        [OR]

    RewriteCond %{HTTP_USER_AGENT}  "${EDGIOS_ON_IOS_10_TO_16_3_VER_ANY}"           [OR]

    RewriteCond %{HTTP_USER_AGENT}  "${FXIOS_IOS_10_TO_16_3_VER_ANY}"               [OR]

    RewriteCond %{HTTP_USER_AGENT}  "=Mozilla/5.0 (iPhone; CPU iPhone OS 15_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) EdgiOS/107.0.1418.8 Version/15.0 Mobile/15E148 Safari/604.1"

    RewriteRule .* - [R=451,L,E=NOBOT:67000]


    ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -
    ##  RULE CONFIDENCE: 10
    ##
    ##  Sec-Fetch-Dest is unexpectedly present over plain HTTP.
    ##
    ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -

    RewriteCond %{REQUEST_SCHEME}       "=http"
    RewriteCond %{HTTP:Sec-Fetch-Dest}  "!^$"

    RewriteCond %{ENV:UA_IS_CHROME}                 "=1"                            [OR]
    RewriteCond %{ENV:UA_IS_EDGE_DESKTOP}           "=1"                            [OR]
    RewriteCond %{ENV:UA_IS_FIREFOX}                "=1"                            [OR]
    RewriteCond %{ENV:UA_IS_SAFARI}                 "=1"                            [OR]

    RewriteCond %{HTTP_USER_AGENT}  "${EDGE_MOBILE_123}"                            [OR]
    RewriteCond %{HTTP_USER_AGENT}  "${EDGE_MOBILE_132}"                            [OR]

    RewriteCond %{HTTP_USER_AGENT}  "${YANDEX_22_7_YOWSER_ON_CHR_114}"              [OR]
    RewriteCond %{HTTP_USER_AGENT}  "${YANDEX_24_1_ON_CHR_120}"                     [OR]

    RewriteCond %{HTTP_USER_AGENT}  "=Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36 uacq"               [OR]

    RewriteCond %{HTTP_USER_AGENT}  "=Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36 Vivaldi/5.3.2679.68"

    RewriteRule .* - [R=451,L,E=NOBOT:67000]


    ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -
    ##  RULE CONFIDENCE: 10
    ##
    ##  Sec-Fetch-Dest value is unexpected.
    ##
    ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -

    RewriteCond %{HTTP:Sec-Fetch-Dest}  '^"macOS"$'

    RewriteRule .* - [R=451,L,E=NOBOT:67000]


  ##
  ##
  ##
  ##  END OF SKIP
  ##
  ##
  ##


  ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -
  ##
  ##  Sec-Fetch-User is unexpectedly present (for plain HTTP or HTTPS).
  ##
  ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -

  RewriteCond %{HTTP:Sec-Fetch-User}  "=?1"

  RewriteCond %{ENV:UA_IS_SAFARI_10_TO_18}                "=1"                    [OR]

  RewriteCond %{HTTP_USER_AGENT}  "${FXIOS_IOS_10_TO_18_VER_ANY}"                 [OR]

  RewriteCond %{HTTP_USER_AGENT}  "=Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko)"

  RewriteRule .* - [R=451,L,E=NOBOT:67000]


  ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -
  ##  RULE CONFIDENCE: TBD
  ##  ANOMALY DETECTED: UNEXPECTED-Fetch
  ##
  ##  Sec-Fetch-Site value is unexpected.
  ##
  ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -

  RewriteCond %{REQUEST_SCHEME}       "=https"
  RewriteCond %{HTTP:Sec-Fetch-Site}  "=?1"

  RewriteCond %{HTTP_USER_AGENT}      "${CHROME_138}"

  RewriteRule .* - [R=451,L,E=NOBOT:67000]


  ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -
  ##  RULE CONFIDENCE: TBD
  ##  ANOMALY DETECTED: NO-Fetch
  ##
  ##  Sec-Fetch-* fields (3) are all missing on root request.
  ##
  ##  NOTES
  ##  - Safari sends these fields as of version 16.4.
  ##  - 2026-01-05. Safari does not send these for downloads (when Accept is just “*/*”).
  ##
  ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -

  RewriteCond %{REQUEST_SCHEME}       "=https"
  RewriteCond %{HTTP:Accept}          "^(application|text)/"

  RewriteCond %{HTTP:Sec-Fetch-Dest}  "^$"
  RewriteCond %{HTTP:Sec-Fetch-Mode}  "^$"
  RewriteCond %{HTTP:Sec-Fetch-Site}  "^$"

  RewriteCond %{HTTP_USER_AGENT}      "${FIREFOX_120}"

  RewriteRule .* - [R=451,L,E=NOBOT:67000]


  ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -
  ##  RULE CONFIDENCE: TBD
  ##  ANOMALY DETECTED: NO-Fetch
  ##
  ##  Sec-Fetch-* fields (3) are all missing on root request.
  ##
  ##  NOTES
  ##  - Safari sends these fields as of version 16.4.
  ##  - 2026-01-05. Safari does not send these for downloads (when Accept is just “*/*”).
  ##
  ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -

  RewriteCond %{REQUEST_SCHEME}       "=https"
  RewriteCond %{REQUEST_URI}          "=/"
  RewriteCond %{HTTP:Accept}          "^(application|text)/"

  RewriteCond %{HTTP:Sec-Fetch-Dest}  "^$"
  RewriteCond %{HTTP:Sec-Fetch-Mode}  "^$"
  RewriteCond %{HTTP:Sec-Fetch-Site}  "^$"

  RewriteCond %{HTTP_USER_AGENT}      "${CHROME_120}"                             [OR]
  RewriteCond %{HTTP_USER_AGENT}      "${CHROME_123}"                             [OR]

  RewriteCond %{HTTP_USER_AGENT}      "${EDGE_DESKTOP_100_TO_119}"                [OR]

  RewriteCond %{HTTP_USER_AGENT}      "${FIREFOX_121}"                            [OR]

  RewriteCond %{HTTP_USER_AGENT}      "^Mozilla/5\.0 \(i[^)]+\) AppleWebKit/[^ ]+ \(KHTML[^)]+\) EdgiOS/116\.[^ ]+ Version/17\.[^ ]+ Mobile/[^ ]+ Safari/[^ ]+$"      [OR]
  RewriteCond %{HTTP_USER_AGENT}      "^Mozilla/5\.0 \(i[^)]+\) AppleWebKit/[^ ]+ \(KHTML[^)]+\) EdgiOS/119\.[^ ]+ Version/17\.[^ ]+ Mobile/[^ ]+ Safari/[^ ]+$"      [OR]
  RewriteCond %{HTTP_USER_AGENT}      "^Mozilla/5\.0 \(i[^)]+\) AppleWebKit/[^ ]+ \(KHTML[^)]+\) EdgiOS/121\.[^ ]+ Version/17\.[^ ]+ Mobile/[^ ]+ Safari/[^ ]+$"      [OR]

  RewriteCond %{HTTP_USER_AGENT}      "^Mozilla/5\.0 \([^)]+\) AppleWebKit/[^ ]+ \(KHTML, like Gecko\) Chrome/121\.[^ ]+ Safari/[^ ]+ Edg/[^ ]+ Trailer/[^ ]+$"

  RewriteRule .* - [R=451,L,E=NOBOT:67000]


  ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -
  ##  RULE CONFIDENCE: TBD
  ##  ANOMALY DETECTED: NO-Fetch
  ##
  ##  Sec-Fetch-* fields (3) are all missing on root request.
  ##
  ##  - - - - - - - - - - - - - - - - - ---- - - - - - - - - - - - - - - - - - - -

  RewriteCond %{REQUEST_SCHEME}       "=https"
  RewriteCond %{REQUEST_URI}          "=/"

  RewriteCond %{HTTP:Sec-Fetch-Dest}  "^$"
  RewriteCond %{HTTP:Sec-Fetch-Mode}  "^$"
  RewriteCond %{HTTP:Sec-Fetch-Site}  "^$"

  RewriteCond %{HTTP_USER_AGENT}  "${CHROME_120}"                                 [OR]

  RewriteCond %{HTTP_USER_AGENT}  "${EDGE_DESKTOP_120}"

  RewriteRule .* - [R=451,L,E=NOBOT:67000]


##
##
##
##  END OF SKIP
##
##
##
